<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <title>Task Export Dashboard</title>
    <link
      rel="stylesheet"
      href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css"
    />
    <link
      rel="stylesheet"
      href="https://cdn.datatables.net/1.13.8/css/dataTables.bootstrap5.min.css"
    />
    <style>
      body {
        padding: 2rem 1rem 3rem;
        background: #f7f7f9;
      }

      h1 {
        margin-bottom: 1.5rem;
        font-size: clamp(1.75rem, 2vw + 1rem, 2.5rem);
      }

      .table-danger {
        background-color: #f8d7da !important;
      }

      .table-warning {
        background-color: #fff3cd !important;
      }

      .table-info {
        background-color: #cff4fc !important;
      }

      .filters {
        gap: 1rem;
      }

      .footer-note {
        margin-top: 2rem;
        color: #6c757d;
        font-size: 0.9rem;
      }
    </style>
  </head>
  <body>
    <main class="container-fluid">
      <div class="row mb-3">
        <div class="col-lg-10 col-xl-8">
          <h1>Task Export Dashboard</h1>
          <p class="lead">
            Use the table below to explore tasks from the latest export. Filter
            by result or severity, and click any Task ID to view the detailed
            HTML report.
          </p>
        </div>
      </div>

      <div class="row mb-3 filters align-items-end">
        <div class="col-sm-6 col-lg-3">
          <label class="form-label" for="result-filter">Result</label>
          <select class="form-select" id="result-filter">
            <option value="">All results</option>
          </select>
        </div>
        <div class="col-sm-6 col-lg-3">
          <label class="form-label" for="severity-filter">Severity</label>
          <select class="form-select" id="severity-filter">
            <option value="">All severities</option>
          </select>
        </div>
      </div>

      <div class="table-responsive">
        <table id="tasks-table" class="table table-striped table-bordered" style="width: 100%">
          <thead>
            <tr>
              <th>Task ID</th>
              <th>Label</th>
              <th>Result</th>
              <th>Severity</th>
              <th>Created</th>
              <th>Updated</th>
              <th>Completed</th>
              <th>Source</th>
            </tr>
          </thead>
          <tbody></tbody>
        </table>
      </div>

      <p class="footer-note">
        Data is loaded from <code>data/tasks.json</code>. Regenerate it with the
        parser after you download a fresh export.
      </p>
    </main>

    <script src="https://code.jquery.com/jquery-3.7.1.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/js/bootstrap.bundle.min.js"></script>
    <script src="https://cdn.datatables.net/1.13.8/js/jquery.dataTables.min.js"></script>
    <script src="https://cdn.datatables.net/1.13.8/js/dataTables.bootstrap5.min.js"></script>
    <script>
      function buildOptionList(values) {
        return Array.from(new Set(values.filter(Boolean)))
          .sort((a, b) => a.localeCompare(b))
          .map((value) => ({ value, label: value }));
      }

      function setOptions(selectEl, options) {
        options.forEach(({ value, label }) => {
          const option = document.createElement("option");
          option.value = value;
          option.textContent = label;
          selectEl.appendChild(option);
        });
      }

      function decorateRow(row, rowData) {
        const result = (rowData.result || "").toLowerCase();
        const severity = (rowData.severity || "").toLowerCase();
        row.classList.remove("table-danger", "table-warning", "table-info");

        if (/error|fail/.test(result) || /critical/.test(severity)) {
          row.classList.add("table-danger");
        } else if (/warn/.test(result) || /warn/.test(severity)) {
          row.classList.add("table-warning");
        } else if (/pending|running/.test(result)) {
          row.classList.add("table-info");
        }
      }

      async function loadTasks() {
        const response = await fetch("../data/tasks.json", { cache: "no-store" });
        if (!response.ok) {
          throw new Error(`Unable to load tasks.json: ${response.statusText}`);
        }
        return response.json();
      }

      $(async function () {
        let tasks = [];
        try {
          tasks = await loadTasks();
        } catch (error) {
          console.error(error);
          const alert = document.createElement("div");
          alert.className = "alert alert-danger";
          alert.role = "alert";
          alert.textContent = "Unable to load data/tasks.json. Make sure you have generated it with the parser.";
          document.querySelector("main").prepend(alert);
          return;
        }

        const resultFilter = document.getElementById("result-filter");
        const severityFilter = document.getElementById("severity-filter");
        setOptions(resultFilter, buildOptionList(tasks.map((task) => task.result)));
        setOptions(severityFilter, buildOptionList(tasks.map((task) => task.severity)));

        const table = $("#tasks-table").DataTable({
          data: tasks,
          deferRender: true,
          order: [[0, "asc"]],
          columns: [
            {
              data: "task_id",
              name: "task_id",
              render: function (data, type, row) {
                if (!data) {
                  data = row.source_path;
                }
                const href = row.source_path ? row.source_path.replace(/\\/g, "/") : "#";
                if (type === "display") {
                  return `<a href="../${href}" target="_blank" rel="noopener">${data || "(unknown)"}</a>`;
                }
                return data;
              },
            },
            { data: "label", name: "label", defaultContent: "" },
            { data: "result", name: "result", defaultContent: "" },
            { data: "severity", name: "severity", defaultContent: "" },
            { data: "created_at", name: "created_at", defaultContent: "" },
            { data: "updated_at", name: "updated_at", defaultContent: "" },
            { data: "completed_at", name: "completed_at", defaultContent: "" },
            {
              data: "source_path",
              name: "source_path",
              render: function (data, type) {
                if (type === "display") {
                  const href = data ? data.replace(/\\/g, "/") : "#";
                  return data ? `<a href="../${href}" target="_blank" rel="noopener">${data}</a>` : "";
                }
                return data;
              },
            },
          ],
          rowCallback: function (row, rowData) {
            decorateRow(row, rowData);
          },
        });

        $(resultFilter).on("change", function () {
          table.column("result:name").search(this.value, true, false).draw();
        });

        $(severityFilter).on("change", function () {
          table.column("severity:name").search(this.value, true, false).draw();
        });
      });
    </script>
  </body>
</html>
